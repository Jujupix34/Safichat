<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>SafiChat ğŸ’–</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
</head>
<body>
  <h1>ğŸŒ¼ OlÃ¡ {{ session['usuario'] }}! Bem-vindo ao canal {{ canal }}!</h1>
  <p>Converse com outros usuÃ¡rios e compartilhe boas energias âœ¨</p>

  <div id="perfil">
    <h2>Seu avatar:</h2>
    <select id="avatar">
      <option value="ğŸŒ¸">ğŸŒ¸ Flor</option>
      <option value="ğŸ¦‹">ğŸ¦‹ Borboleta</option>
      <option value="ğŸŒˆ">ğŸŒˆ Arco-Ã­ris</option>
      <option value="ğŸ±">ğŸ± Gato</option>
      <option value="ğŸ¨">ğŸ¨ Artista</option>
    </select>

    <textarea id="bio" placeholder="Escreva uma bio curta..."></textarea>
    <select id="status">
      <option value="ğŸ˜Š Feliz">ğŸ˜Š Feliz</option>
      <option value="ğŸ˜” Triste">ğŸ˜” Triste</option>
      <option value="ğŸ˜¡ Irritada">ğŸ˜¡ Irritada</option>
      <option value="ğŸ˜´ Cansada">ğŸ˜´ Cansada</option>
      <option value="ğŸ¤” Pensativa">ğŸ¤” Pensativa</option>
    </select>
    <button onclick="enviarPerfil()">Atualizar perfil</button>
  </div>

  <div id="chat">
    <h2>ğŸ’¬ Canal: {{ canal }}</h2>
    <ul id="messages"></ul>
    <div class="input-area">
      <input id="msg" autocomplete="off" placeholder="Digite sua mensagem..." />
      <button onclick="sendMessage()">Enviar</button>
      <button id="emoji-button">ğŸ˜Š</button>
    </div>
  </div>

  <script>
    const socket = io();
    const input = document.getElementById('msg');
    const emojiBtn = document.querySelector('#emoji-button');
    const picker = new EmojiButton();

    emojiBtn.addEventListener('click', () => {
      picker.togglePicker(emojiBtn);
    });

    picker.on('emoji', emoji => {
      input.value += emoji;
    });

    function enviarPerfil() {
      const avatar = document.getElementById('avatar').value;
      const bio = document.getElementById('bio').value.trim();
      const status = document.getElementById('status').value;
      socket.emit('perfil', {
        nome: "{{ session['usuario'] }}",
        avatar,
        canal: "{{ canal }}",
        bio,
        status
      });
    }

    function sendMessage() {
      const avatar = document.getElementById('avatar').value;
      const msg = input.value.trim();
      if (msg !== "") {
        socket.emit('message', `${avatar} {{ session['usuario'] }}: ${msg}`);
        input.value = '';
      }
    }

    socket.on('message', function(msg) {
      const item = document.createElement('li');
      item.innerHTML = `
        <div class="msg-box">
          <span>${msg}</span>
          <button class="reply-btn" onclick="replyTo('${escapeQuotes(msg)}')">â†ª Responder</button>
        </div>
      `;
      document.getElementById('messages').appendChild(item);
    });

    function replyTo(message) {
      const name = message.split(':')[0];
      input.value = `@${name} `;
      input.focus();
    }

    function escapeQuotes(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
  </script>
</body>
</html>
